<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.simsim.modules.survey.SurveyMapper">

    <resultMap id="resultMapObj" type="com.simsim.modules.survey.Survey"></resultMap>
	
	<select id="selectList" resultMap="resultMapObj">
		SELECT
			snSeq
			,a.survey,
		    a.surveyPhrase
		FROM jsSurveyName a
		WHERE 1=1
	</select>

	<select id="selectOne" resultMap="resultMapObj">
		SELECT
			a.survey
			,a.surveyPhrase
			,a.surveyExplain
		   <!--  b.question,
		    b.questionContent,
		    c.choice,
		    c.choiceContent -->
		FROM jsSurveyName a
		<!-- inner join jsSurveyQuestion b on b.jsSurveyName_snSeq = a.snSeq
		inner join jsQuestionChoice c on b.sqSeq = c.jsSurveyQuestion_sqSeq -->
		WHERE 1=1
			AND a.snSeq=#{snSeq}
	</select>
	
	<select id="selectSurveyCommentCount" resultType="Integer">
		SELECT COUNT(*)
		From jsSurveyComment
		WHERE 1=1
			AND snSeq = #{snSeq}
			AND delNy = 0
	</select>
	
	<select id="selectSurveyCommentList" resultMap="resultMapObj">
	SELECT
		scSeq
		,nickname
		,seq
		,commentContent
		,datetime
	FROM jsSurveyComment
	WHERE 1=1 
		AND snSeq = #{snSeq}
		AND delNy = 0
	</select>
	
	<insert id="CommentInst">
		INSERT INTO jsSurveyComment(
			seq
			,snSeq
			,nickname
			,commentContent
			,delNy
		)
		VALUES(
			#{seq}
			,#{snSeq}
			,#{nickname}
			,#{commentContent}
			,0
		)
		<selectKey resultType="String" keyProperty="scSeq" order="AFTER">
			SELECT last_insert_id()
		</selectKey>
	</insert>
	
	<update id="CommentUpdt">
		UPDATE jsSurveyComment
		SET
			seq = #{seq}
			,snSeq = #{snSeq}
			,nickname =#{nickname}
			,commentContent =#{commentContent}
			,delNy =#{delNy}
		WHERE 1=1
			AND scSeq = #{scSeq}
	</update>
	
	<update id="CommentVele">
		Update jsSurveyComment
		SET
			delNy = 1
		WHERE
			scSeq = #{scSeq}
	</update>

	<!-- 유저 인터페이스 s-->
	<select id="selectUserRecord" resultMap="resultMapObj">
<!-- 		SELECT 
		a.srcSeq,
	    d.survey,
	    b.nickname,
	    c.resultTitle,
	    a.datetime
	FROM jsSurveyRecord a
	inner join jsMember b on b.seq = a.jsMember_seq 
	<![CDATA[
	inner join jsSurveyResult c on c.scoreRangeStart <= a.totalScore AND c.scoreRangeEnd >= a.totalScore
	]]>
	inner join jsSurveyName d on d.snSeq = a.jsSurveyName_snSeq
		AND b.seq = #{seq} -->
		SELECT 
			a.srcSeq
		    ,(SELECT survey FROM jsSurveyName d WHERE d.snSeq = a.jsSurveyName_snSeq) as survey
		    ,nickname
		    <![CDATA[
		    ,(SELECT resultTitle FROM jsSurveyResult c WHERE c.scoreRangeStart <= a.totalScore AND c.scoreRangeEnd >= a.totalScore AND a.jsSurveyName_snSeq = c.jsSurveyName_snSeq) as resultTitle
		    ]]>
		    ,a.datetime
		FROM jsSurveyRecord a
		inner join jsMember b on b.seq = a.jsMember_seq 
			AND b.seq = #{seq}
	</select>
	
	<select id="selectMyComment" resultMap="resultMapObj">
		SELECT
			a.scSeq,
		    c.survey,
		    a.nickname,
		    a.commentContent,
		    a.datetime
		FROM jsSurveyComment a
		inner join jsMember b on b.seq = a.snSeq
		inner join jsSurveyName c on c.snSeq = a.snSeq
		WHERE 1=1
			AND a.seq =#{seq}
			AND a.delNy = 0
	</select>
	
	<select id="selectSurveyContentQuestion" resultMap="resultMapObj">
		SELECT
			b.sqSeq
			,a.survey
		    ,b.question
		    ,b.questionContent
		FROM jsSurveyName a
		inner join jsSurveyQuestion b on b.jsSurveyName_snSeq = a.snSeq
		AND snSeq=#{snSeq}
	</select>
	
	<select id="selectSurveyContentChoice" resultMap="resultMapObj">
		SELECT
			a.survey
		    ,c.jsSurveyQuestion_sqSeq as sqSeq
			,c.choice
			,c.choiceContent
			,c.choiceScore
		FROM jsSurveyName a
		inner join jsSurveyQuestion b on b.jsSurveyName_snSeq = a.snSeq
		inner join jsQuestionChoice c on c.jsSurveyQuestion_sqSeq = b.sqSeq
	</select>
	
	<!-- 유저 인터페이스 e-->
	<!-- 테스트 내용 작성 s -->
	<insert id="insertSurveyName">
		INSERT INTO jsSurveyName(
			survey
			,surveyPhrase
			,surveyExplain
			,openNy
		)
		VALUES (
			#{survey}
			,#{surveyPhrase}
			,#{surveyExplain}
			,#{openNy}
		)
		<selectKey resultType="String" keyProperty="snSeq" order="AFTER">
			SELECT last_insert_id()
		</selectKey>
	</insert>
	
	<insert id="insertSurveyQestion">
		INSERT INTO jsSurveyQuestion(
			snSeq
			,question
			,questionContent
		)
		VALUES(
			#{snSeq}
			,#{question}
			,#{questionContent}
		)
		<selectKey resultType="String" keyProperty="sqSeq" order="AFTER">
			SELECT last_insert_id()
		</selectKey>
	</insert>
	
	<insert id="insertChoice">
		INSERT INTO jsQuestionChoice(
			sqSeq
			,choice
			,choiceContent
			,choiceScore
		)
		VALUES(
			#{sqSeq}
			,#{choice}
			,#{choiceContent}
			,#{choiceScore}
		)
		<selectKey resultType="String" keyProperty="sqcSeq" order="AFTER">
			SELECT last_insert_id()
		</selectKey>
	</insert>
	
	<insert id="insertResult">
		INSERT INTO jsSurveyResult(
			snSeq
			,resultNum
			,resultTitle
			,resultSmTitle
			,resultContent
			,scoreRangeStart
			,scoreRangeEnd
			,relation1
			,relation2
		)
		VALUES(
			#{snSeq}
			,#{resultNum}
			,#{resultTitle}
			,#{resultSmTitle}
			,#{resultContent}
			,#{scoreRangeStart}
			,#{scoreRangeEnd}
			,#{relation1}
			,#{relation2}
		)
		<selectKey resultType="String" keyProperty="srSeq" order="AFTER">
			SELECT last_insert_id()
		</selectKey>
	</insert>
	<!-- 테스트 내용 작성 e -->
	
</mapper>